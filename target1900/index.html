<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ターゲット1900</title>
  <link rel="icon" href="/target1900/target1900.png" type="image/png">
  <link rel="apple-touch-icon" href="/target1900/target1900.png" sizes="180x180">
  <link rel="manifest" href="/target1900/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="/target1900/style.css">
</head>
<body>
  <div class="container">
    <h1>ターゲット1900</h1>
    <p>指定範囲の中からランダムに問題を出題！</p>

    <div class="form-group">
      <label>出題方向：</label>
      <select id="direction">
        <option value="reverse">日本語 → 英語</option>
        <option value="normal">英語 → 日本語</option>
        <option value="random">ランダム</option>
      </select>
    </div>

    <div class="form-group">
      <label>出題する問題数：</label>
      <input type="number" id="questionCount" min="1">
    </div>

    <div class="form-group">
      <label>開始番号：</label>
      <input type="number" id="startNumber" min="1">
    </div>

    <div class="form-group">
      <label>終了番号：</label>
      <input type="number" id="endNumber" min="1">
    </div>

    <button class="generate-button" id="btnGenerate">作成</button>
    <button class="generate-button" id="btnPDF">PDFダウンロード</button>

    <div id="questionsContainer"></div>
  </div>

  <!-- jsPDF（ES module版） -->
  <script type="module">
    import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";

    const allQuestions = [
      { number: 1, question: "create", answer: "を創り出す；を引き起こす" },
      { number: 2, question: "increase", answer: "を向上させる；よくなる" },
      { number: 3, question: "mean", answer: "を意味する；つもりである" },
      { number: 4, question: "consider", answer: "を見なす；について考える" },
      { number: 5, question: "suggest", answer: "を提案する；を暗示する" },
      { number: 6, question: "decide", answer: "を決める；に決着をつける" },
      { number: 7, question: "share", answer: "を共有する；を分担する" },
      { number: 8, question: "save", answer: "を保存する；を蓄える" },
      { number: 9, question: "attend", answer: "傾向がある；を世話する" },
      { number: 10, question: "accompany", answer: "を関与させる；を伴う" }
    ];

    let selectedQuestions = [];
    let currentDirection = 'normal';

    document.getElementById('btnGenerate').addEventListener('click', () => {
      const count = parseInt(document.getElementById('questionCount').value);
      const start = parseInt(document.getElementById('startNumber').value);
      const end = parseInt(document.getElementById('endNumber').value);
      const direction = document.getElementById('direction').value;
      currentDirection = direction;

      if (isNaN(count) || count < 1) return alert("正しい問題数を入力してください。");
      if (isNaN(start) || isNaN(end) || start < 1 || end < start) return alert("開始・終了番号を確認してください。");

      const filtered = allQuestions.filter(q => q.number >= start && q.number <= end);
      if (filtered.length === 0) return alert("指定範囲に問題がありません！");
      if (count > filtered.length) return alert(`指定範囲には${filtered.length}問しかありません。`);

      selectedQuestions = [...filtered].sort(() => 0.5 - Math.random()).slice(0, count);
      renderQuestions();
    });

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      selectedQuestions.forEach(q => {
        let dir = currentDirection === 'random' ? (Math.random() < 0.5 ? 'normal' : 'reverse') : currentDirection;
        const showQ = dir === 'normal' ? q.question : q.answer;
        const showA = dir === 'normal' ? q.answer : q.question;

        const box = document.createElement('div');
        box.className = 'question-box';
        box.innerHTML = `
          <div class="question"><strong>Q${q.number}.</strong> ${showQ}</div>
          <button class="reveal-button">答えをチェック</button>
          <div class="answer" style="display:none">${showA}</div>
        `;
        box.querySelector('.reveal-button').addEventListener('click', e => {
          e.target.style.display='none';
          box.querySelector('.answer').style.display='block';
        });
        container.appendChild(box);
      });
    }

    document.getElementById('btnPDF').addEventListener('click', async () => {
      if (selectedQuestions.length === 0) return alert("先にテストを作成してください。");

      const fontUrl = "/target1900/ZenKurenaido-Regular.ttf";
      const fontData = await fetch(fontUrl).then(r => r.arrayBuffer());
      const base64 = btoa(String.fromCharCode(...new Uint8Array(fontData)));

      const startNo = selectedQuestions[0].number;
      const endNo = selectedQuestions[selectedQuestions.length - 1].number;

      const doc = new jsPDF();
      doc.addFileToVFS("ZenKurenaido-Regular.ttf", base64);
      doc.addFont("ZenKurenaido-Regular.ttf", "ZenKurenaido", "normal");
      doc.setFont("ZenKurenaido");

      // 1ページ：問題
      doc.setFontSize(16);
      doc.text(`ターゲット1900［6訂版］（No.${startNo}〜No.${endNo}）`, 10, 20);
      doc.setFontSize(12);
      selectedQuestions.forEach((q, i) => {
        let dir = currentDirection === 'random' ? (Math.random() < 0.5 ? 'normal' : 'reverse') : currentDirection;
        const textQ = dir === 'normal' ? q.question : q.answer;
        doc.text(`（${i+1}）${textQ}［${q.number}］`, 10, 30 + i*10);
        doc.text(`（${i+1}）＿＿＿＿＿＿＿＿＿＿＿＿`, 110, 30 + i*10);
      });

      // 2ページ：解答
      doc.addPage();
      doc.setFontSize(16);
      doc.text("【解答】", 10, 20);
      doc.setFontSize(12);
      selectedQuestions.forEach((q, i) => {
        let dir = currentDirection === 'random' ? (Math.random() < 0.5 ? 'normal' : 'reverse') : currentDirection;
        const textA = dir === 'normal' ? q.answer : q.question;
        doc.text(`（${i+1}）${textA}`, 10, 30 + i*10);
      });

      doc.save("target1900_test.pdf");
    });

    // Service Worker登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/target1900/sw.js')
        .then(reg => console.log('SW登録成功', reg))
        .catch(err => console.log('SW登録失敗', err));
    }
  </script>
</body>
</html>
